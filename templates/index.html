<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fetch</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 24px; margin: 0 0 16px; }
    .card { background: rgba(127,127,127,0.08); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    label { display: block; margin-bottom: 8px; }
    input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(127,127,127,0.4); background: transparent; color: inherit; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(127,127,127,0.4); background: #3b82f6; color: #fff; cursor: pointer; }
    button.secondary { background: transparent; color: inherit; }
    .row { display: flex; gap: 8px; align-items: center; }
    .space { height: 12px; }
    .formats { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .group { border: 1px solid rgba(127,127,127,0.3); border-radius: 10px; padding: 10px; }
    .group h3 { margin: 0 0 8px; font-size: 16px; }
    .radio { display: flex; align-items: center; gap: 8px; padding: 6px 4px; border-radius: 8px; cursor: pointer; }
    .radio:hover { background: rgba(127,127,127,0.12); }
    .muted { opacity: 0.75; font-size: 13px; }
    .progress { height: 14px; background: rgba(127,127,127,0.2); border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: #22c55e; transition: width 0.2s ease; }
    .hidden { display: none; }
    .title { font-weight: 600; }
    .thumb { width: 160px; height: 90px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(127,127,127,0.3); }
    .header { display: flex; gap: 12px; align-items: center; }
    a.button { text-decoration: none; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fetch</h1>
    <div class="card">
      <label for="url">YouTube URL</label>
      <div class="row">
        <input id="url" type="text" placeholder="https://youtube.com/watch?v=..." />
        <button id="analyze">Analyze Video</button>
      </div>
      <div class="muted" id="hint">Paste a YouTube link and click Analyze.</div>
    </div>

    <div id="analysis" class="card hidden">
      <div class="header">
        <img id="thumb" class="thumb" alt="thumbnail" />
        <div>
          <div class="title" id="videoTitle">Video Title</div>
          <div class="muted" id="duration">Duration</div>
        </div>
      </div>
      <div class="space"></div>
      <div class="formats">
        <div class="group">
          <h3>Complete Files (video + audio)</h3>
          <div id="group-video-audio"></div>
        </div>
        <div class="group">
          <h3>Video Only</h3>
          <div id="group-video-only"></div>
        </div>
        <div class="group">
          <h3>Audio Only</h3>
          <div id="group-audio-only"></div>
        </div>
      </div>
      <div class="space"></div>
      <div class="row">
        <button id="download">Download Selected</button>
        <button class="secondary" id="clear">New Analysis</button>
      </div>
      <div id="analysisError" class="muted"></div>
    </div>

    <div id="progressCard" class="card hidden">
      <div>Downloading: <span id="dlTitle"></span></div>
      <div class="space"></div>
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="muted" id="stats">Speed: — ETA: —</div>
      <div class="space"></div>
      <div class="row">
        <button id="cancel" class="secondary">Cancel</button>
        <a id="downloadLink" class="button hidden" href="#" download>Download File</a>
        <button id="newDownload" class="hidden">New Download</button>
      </div>
      <div id="progressError" class="muted"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmtBytes = (bytes) => {
      if (!bytes && bytes !== 0) return "?";
      const units = ['B','KB','MB','GB','TB'];
      let i = 0; let num = bytes;
      while (num >= 1024 && i < units.length-1) { num /= 1024; i++; }
      return `${num.toFixed( (i <= 1) ? 0 : 1)}${units[i]}`;
    };
    const fmtDuration = (s) => {
      if (!s) return 'Unknown';
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = Math.floor(s % 60);
      return [h, m, sec].filter((v, idx) => v || idx > 0).map(v => String(v).padStart(2, '0')).join(':');
    };

    let lastAnalysis = null;
    let selectedFormatId = null;
    let currentDownloadId = null;
    let es = null;

    const renderFormats = (data) => {
      const mkRadio = (f) => {
        const id = `fmt_${f.format_id}`;
        const size = f.filesize ? fmtBytes(f.filesize) : 'unknown';
        const label = `${f.quality_label || ''} ${f.ext ? '('+f.ext+')' : ''} — ${size}`;
        const div = document.createElement('label');
        div.className = 'radio';
        div.innerHTML = `<input type="radio" name="format" value="${f.format_id}" id="${id}" /> <span>${label}</span>`;
        div.querySelector('input').addEventListener('change', () => { selectedFormatId = f.format_id; });
        return div;
      };
      const m = data.categorized || { video_audio: [], video_only: [], audio_only: [] };
      const groups = {
        'group-video-audio': m.video_audio,
        'group-video-only': m.video_only,
        'group-audio-only': m.audio_only,
      };
      Object.entries(groups).forEach(([id, list]) => {
        const container = $(id);
        container.innerHTML = '';
        (list || []).forEach(f => container.appendChild(mkRadio(f)));
      });
    };

    const resetUI = () => {
      selectedFormatId = null;
      currentDownloadId = null;
      if (es) { es.close(); es = null; }
      $('bar').style.width = '0%';
      $('stats').textContent = 'Speed: — ETA: —';
      $('progressError').textContent = '';
      $('downloadLink').classList.add('hidden');
      $('newDownload').classList.add('hidden');
      $('cancel').classList.remove('hidden');
    };

    $('analyze').addEventListener('click', async () => {
      const url = $('url').value.trim();
      $('analysisError').textContent = '';
      if (!url) { $('analysisError').textContent = 'Please enter a URL.'; return; }
      try {
        const res = await fetch('/analyze', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (!res.ok) { $('analysisError').textContent = data.error || 'Failed to analyze.'; return; }
        lastAnalysis = data;
        $('analysis').classList.remove('hidden');
        $('videoTitle').textContent = `${data.title || 'Unknown Title'}`;
        $('duration').textContent = `Duration: ${fmtDuration(data.duration)}`;
        $('thumb').src = data.thumbnail || '';
        renderFormats(data);
      } catch (e) {
        $('analysisError').textContent = 'Network error while analyzing.';
      }
    });

    $('clear').addEventListener('click', () => {
      $('analysis').classList.add('hidden');
      $('progressCard').classList.add('hidden');
      $('analysisError').textContent = '';
      $('progressError').textContent = '';
      $('url').focus();
      if (es) { es.close(); es = null; }
    });

    $('download').addEventListener('click', async () => {
      $('progressError').textContent = '';
      if (!lastAnalysis) { $('analysisError').textContent = 'Analyze a video first.'; return; }
      if (!selectedFormatId) { $('analysisError').textContent = 'Select a format first.'; return; }
      try {
        const url = $('url').value.trim();
        const res = await fetch('/download', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, format_id: selectedFormatId })
        });
        const data = await res.json();
        if (!res.ok) { $('progressError').textContent = data.error || 'Failed to start download.'; return; }
        currentDownloadId = data.download_id;
        $('dlTitle').textContent = lastAnalysis.title || 'Download';
        $('progressCard').classList.remove('hidden');
        resetUI();

        es = new EventSource(`/progress/${currentDownloadId}`);
        es.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (typeof msg.progress === 'number') {
              $('bar').style.width = `${msg.progress.toFixed(1)}%`;
            }
            $('stats').textContent = `Speed: ${msg.speed || '—'}   ETA: ${msg.eta || '—'}`;
            if (msg.status === 'complete') {
              es && es.close();
              $('downloadLink').href = `/downloads/${currentDownloadId}`;
              $('downloadLink').classList.remove('hidden');
              $('newDownload').classList.remove('hidden');
              $('cancel').classList.add('hidden');
            }
            if (msg.status === 'failed' || msg.error) {
              es && es.close();
              $('progressError').textContent = msg.error || 'Download failed.';
              $('newDownload').classList.remove('hidden');
              $('cancel').classList.add('hidden');
            }
          } catch {}
        };
        es.onerror = () => {
          // Keep quiet; server might close after completion
        };
      } catch (e) {
        $('progressError').textContent = 'Network error while starting download.';
      }
    });

    $('cancel').addEventListener('click', async () => {
      if (!currentDownloadId) return;
      try {
        await fetch(`/cancel/${currentDownloadId}`, { method: 'POST' });
      } catch {}
    });

    $('newDownload').addEventListener('click', () => {
      $('progressCard').classList.add('hidden');
      $('analysis').classList.add('hidden');
      $('url').value = '';
      $('url').focus();
    });
  </script>
</body>
</html>


